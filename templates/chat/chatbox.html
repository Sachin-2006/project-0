<!DOCTYPE html>
<html>
<body>
    <center><h1>Hello , Welcome to my chat site ! {{request.user}} - {{room_name_json}}</h1></center>
    <br>
    {% if request.user.is_authenticated %}
    <center> Logout the chat Page <a href = "{% url 'logout' %}">Logout</a></center>
    {% endif %}
    <div
    class="chat__item__container"
    id="id_chat_item_container"
    style="font-size: 20px"
    >
            {% for message in messages %}
        {% if message.sender == request.user %}
        You : {{message.message}}<br>
        {% else %}
        {{message.receiver}}:{{message.message}}<br>
        {% endif %}
        {% endfor %}
    <br />
    </div>
    <input type="text" id="id_message_send_input" />
    <button type="submit" id="id_message_send_button">Send Message</button>
    <br />
    <br />
    


    <script>
        var st = {{room_name_json}}
        const chatSocket = new WebSocket('ws://'+window.location.host+'/ws/chat/'+st+'/');
        console.log()
    chatSocket.onopen = function (e) {
        console.log("The connection was setup successfully !");
    };
    chatSocket.onclose = function (e) {

        console.log(e.code);
    };
    document.querySelector("#id_message_send_input").focus();
    document.querySelector("#id_message_send_input").onkeyup = function (e) {
        if (e.keyCode == 13) {
        document.querySelector("#id_message_send_button").click();
        }
    };
    document.querySelector("#id_message_send_button").onclick = function (e) {
        var messageInput = document.querySelector(
        "#id_message_send_input"
        ).value;
        chatSocket.send(JSON.stringify({ message: messageInput, sender : "{{request.user.username}}",receiver:"{{receiver}}"}));
    };
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data)
        var div = document.createElement("div");
        div.innerHTML = data.sender + " : " + data.message;
        document.querySelector("#id_message_send_input").value = "";
        document.querySelector("#id_chat_item_container").appendChild(div);
    };
    </script>
</body>
</html>
